[{"content":"ipmitool sdr elist å‘½ä»¤ç”¨äºæ˜¾ç¤ºç³»ç»Ÿä¼ æ„Ÿå™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚\nSEL å’Œ SDR æ˜¯ IPMIï¼ˆIntelligent Platform Management Interfaceï¼‰ä¸­çš„ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤ºç³»ç»Ÿäº‹ä»¶æ—¥å¿—å’Œä¼ æ„Ÿå™¨æ•°æ®è®°å½•ã€‚\n1. SEL (System Event Log) SEL ä»£è¡¨ System Event Logï¼Œå³ç³»ç»Ÿäº‹ä»¶æ—¥å¿—ã€‚å®ƒæ˜¯ä¸€ä¸ªè®°å½•äº†ç³»ç»Ÿä¸­å…³é”®äº‹ä»¶çš„æ—¥å¿—æ–‡ä»¶ï¼Œé€šå¸¸åŒ…æ‹¬ç¡¬ä»¶æ•…éšœã€è­¦å‘Šã€ç³»ç»Ÿå¯åŠ¨å’Œå…³é—­äº‹ä»¶ç­‰ã€‚SEL é€šå¸¸ç”¨äºè¯Šæ–­å’Œæ’é™¤ç¡¬ä»¶é—®é¢˜ã€‚äº‹ä»¶æ—¥å¿—ä¼šè®°å½•äº‹ä»¶çš„æ—¶é—´æˆ³ã€äº‹ä»¶ç±»å‹ã€ä¸¥é‡ç¨‹åº¦ä»¥åŠç›¸å…³çš„è¯¦ç»†ä¿¡æ¯ã€‚\nå‘½ä»¤ç¤ºä¾‹: ä½¿ç”¨ ipmitool æŸ¥çœ‹ SELï¼š 1 sudo ipmitool sel list è¿™ä¸ªå‘½ä»¤ä¼šåˆ—å‡ºæ‰€æœ‰è®°å½•çš„ç³»ç»Ÿäº‹ä»¶ï¼Œå¸®åŠ©ç®¡ç†å‘˜åˆ†æç³»ç»Ÿä¸­çš„å¼‚å¸¸æƒ…å†µã€‚ 2. SDR (Sensor Data Record) SDR ä»£è¡¨ Sensor Data Recordï¼Œå³ä¼ æ„Ÿå™¨æ•°æ®è®°å½•ã€‚å®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ç³»ç»Ÿä¸­çš„æ•°æ®åº“ï¼ŒåŒ…å«äº†ç³»ç»Ÿå†…æ‰€æœ‰ä¼ æ„Ÿå™¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¼ æ„Ÿå™¨çš„ç±»å‹ã€åç§°ã€IDã€çŠ¶æ€ã€å½“å‰å€¼ã€æŠ¥è­¦é˜ˆå€¼ç­‰ã€‚SDR æ˜¯ IPMI ç³»ç»Ÿä¸­ç”¨äºç›‘æ§å’Œç®¡ç†ç¡¬ä»¶çŠ¶æ€çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚\nå‘½ä»¤ç¤ºä¾‹: ä½¿ç”¨ ipmitool æŸ¥çœ‹ SDRï¼š 1 sudo ipmitool sdr è¿™ä¸ªå‘½ä»¤ä¼šåˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰ä¼ æ„Ÿå™¨çš„çŠ¶æ€å’Œè¯»æ•°ï¼Œå…è®¸ç®¡ç†å‘˜ç›‘æ§ç³»ç»Ÿçš„å¥åº·çŠ¶æ€ã€‚ æ€»ç»“ï¼š SEL ç”¨äºè®°å½•å’ŒæŸ¥çœ‹ç³»ç»Ÿäº‹ä»¶ï¼Œå¸®åŠ©è¯Šæ–­å’Œæ’é™¤æ•…éšœã€‚ SDR ç”¨äºå­˜å‚¨å’Œç®¡ç†ä¼ æ„Ÿå™¨æ•°æ®ï¼Œå®æ—¶ç›‘æ§ç³»ç»Ÿçš„å„é¡¹å‚æ•°ã€‚ äº†è§£ SEL å’Œ SDR æ˜¯ IPMI ç®¡ç†çš„é‡è¦éƒ¨åˆ†ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç»´æŠ¤å’Œç®¡ç†æœåŠ¡å™¨çš„ç¡¬ä»¶çŠ¶æ€ã€‚\nè¾“å‡ºçš„æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªç”µæºæ¨¡å—ï¼ˆPS1ã€PS2ã€PS3ã€PS4ï¼‰çš„çŠ¶æ€ã€‚ä»¥ä¸‹æ˜¯è¾“å‡ºä¿¡æ¯çš„å«ä¹‰ï¼š\nPS1 Status:\nC4h: ä¼ æ„Ÿå™¨IDï¼Œå…·ä½“çš„æ•°å€¼å› ç¡¬ä»¶è€Œå¼‚ã€‚ ok: çŠ¶æ€æ­£å¸¸ã€‚ 10.92: ç”µå‹æˆ–ç±»ä¼¼çš„æ•°å€¼ï¼Œè¿™é‡Œé€šå¸¸è¡¨ç¤ºä¸ç”µæºç›¸å…³çš„æ•°å€¼ã€‚ Presence detected: è¡¨ç¤ºç”µæºæ¨¡å—è¢«æ£€æµ‹åˆ°å­˜åœ¨ã€‚ PS2 Status:\nC5h: ä¼ æ„Ÿå™¨IDã€‚ ok: çŠ¶æ€æ­£å¸¸ã€‚ 10.91: ç”µå‹æˆ–ç±»ä¼¼çš„æ•°å€¼ã€‚ Presence detected, Failure detected: è¡¨ç¤ºç”µæºæ¨¡å—è¢«æ£€æµ‹åˆ°å­˜åœ¨ï¼Œä½†ä¹Ÿæ£€æµ‹åˆ°æ•…éšœã€‚ PS3 Status:\nC6h: ä¼ æ„Ÿå™¨IDã€‚ ok: çŠ¶æ€æ­£å¸¸ã€‚ 10.90: ç”µå‹æˆ–ç±»ä¼¼çš„æ•°å€¼ã€‚ Presence detected: è¡¨ç¤ºç”µæºæ¨¡å—è¢«æ£€æµ‹åˆ°å­˜åœ¨ã€‚ PS4 Status:\nC7h: ä¼ æ„Ÿå™¨IDã€‚ ok: çŠ¶æ€æ­£å¸¸ã€‚ 10.89: ç”µå‹æˆ–ç±»ä¼¼çš„æ•°å€¼ã€‚ Presence detected: è¡¨ç¤ºç”µæºæ¨¡å—è¢«æ£€æµ‹åˆ°å­˜åœ¨ã€‚ å…³é”®ç‚¹ï¼š Presence detected: ç”µæºæ¨¡å—è¢«æ£€æµ‹åˆ°ã€‚ Failure detected: ä»…åœ¨ PS2 ä¸­å‡ºç°ï¼Œè¡¨æ˜è¿™ä¸ªç”µæºæ¨¡å—å­˜åœ¨æŸç§æ•…éšœã€‚è™½ç„¶çŠ¶æ€æ˜¾ç¤ºä¸º okï¼Œä½†è¿™å¯èƒ½æ˜¯å› ä¸ºæ•…éšœå¹¶ä¸å½±å“ç³»ç»Ÿçš„æ•´ä½“è¿è¡Œï¼Œä½†ä»ç„¶å€¼å¾—è¿›ä¸€æ­¥æ£€æŸ¥ã€‚ ä½ å¯èƒ½éœ€è¦æ£€æŸ¥ PS2 çš„å…·ä½“çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦é€šè¿‡ ipmitool è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯æˆ–æŸ¥çœ‹ç›¸å…³æ—¥å¿—ï¼Œç¡®ä¿ç”µæºæ¨¡å—åœ¨æœªæ¥ä¸ä¼šå¼•å‘æ›´ä¸¥é‡çš„é—®é¢˜ã€‚\n","permalink":"http://119.91.218.8/zh/posts/1556/","summary":"\u003cp\u003e\u003ccode\u003eipmitool sdr elist\u003c/code\u003e å‘½ä»¤ç”¨äºæ˜¾ç¤ºç³»ç»Ÿä¼ æ„Ÿå™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eSEL\u003c/code\u003e å’Œ \u003ccode\u003eSDR\u003c/code\u003e æ˜¯ \u003ccode\u003eIPMI\u003c/code\u003eï¼ˆIntelligent Platform Management Interfaceï¼‰ä¸­çš„ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤ºç³»ç»Ÿäº‹ä»¶æ—¥å¿—å’Œä¼ æ„Ÿå™¨æ•°æ®è®°å½•ã€‚\u003c/p\u003e","title":"ç”µæºæ•…éšœæŸ¥è¯¢æŒ‡ä»¤"},{"content":"ä»Šå¤©åœ¨å°è¯•å¤ç°quip#çš„æ—¶å€™å‘ç°äº†é—®é¢˜ï¼Œåœ¨è¿›è¡Œsetup installçš„æ—¶å€™å‘ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 [1/3] /usr/local/cuda/bin/nvcc --generate-dependencies-with-compile --dependency-output /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o.d -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/torch/csrc/api/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/TH -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/THC -I/usr/local/cuda/include -I/home/ubuntu/miniconda3/envs/quant/include/python3.11 -c -c /home/ubuntu/data/exp/quip-sharp/quiptools/quiptools.cu -o /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o -D__CUDA_NO_HALF_OPERATORS__ -D__CUDA_NO_HALF_CONVERSIONS__ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr --compiler-options \u0026#39;\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;-fPIC\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;\u0026#39; -O2 -g -Xcompiler -rdynamic -lineinfo -std=c++20 -DTORCH_API_INCLUDE_EXTENSION_H \u0026#39;-DPYBIND11_COMPILER_TYPE=\u0026#34;_gcc\u0026#34;\u0026#39; \u0026#39;-DPYBIND11_STDLIB=\u0026#34;_libstdcpp\u0026#34;\u0026#39; \u0026#39;-DPYBIND11_BUILD_ABI=\u0026#34;_cxxabi1011\u0026#34;\u0026#39; -DTORCH_EXTENSION_NAME=quiptools_cuda -D_GLIBCXX_USE_CXX11_ABI=0 -gencode=arch=compute_89,code=compute_89 -gencode=arch=compute_89,code=sm_89 FAILED: /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o /usr/local/cuda/bin/nvcc --generate-dependencies-with-compile --dependency-output /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o.d -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/torch/csrc/api/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/TH -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/THC -I/usr/local/cuda/include -I/home/ubuntu/miniconda3/envs/quant/include/python3.11 -c -c /home/ubuntu/data/exp/quip-sharp/quiptools/quiptools.cu -o /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o -D__CUDA_NO_HALF_OPERATORS__ -D__CUDA_NO_HALF_CONVERSIONS__ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr --compiler-options \u0026#39;\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;-fPIC\u0026#39;\u0026#34;\u0026#39;\u0026#34;\u0026#39;\u0026#39; -O2 -g -Xcompiler -rdynamic -lineinfo -std=c++20 -DTORCH_API_INCLUDE_EXTENSION_H \u0026#39;-DPYBIND11_COMPILER_TYPE=\u0026#34;_gcc\u0026#34;\u0026#39; \u0026#39;-DPYBIND11_STDLIB=\u0026#34;_libstdcpp\u0026#34;\u0026#39; \u0026#39;-DPYBIND11_BUILD_ABI=\u0026#34;_cxxabi1011\u0026#34;\u0026#39; -DTORCH_EXTENSION_NAME=quiptools_cuda -D_GLIBCXX_USE_CXX11_ABI=0 -gencode=arch=compute_89,code=compute_89 -gencode=arch=compute_89,code=sm_89 /usr/include/x86_64-linux-gnu/bits/floatn-common.h(214): error: invalid combination of type specifiers typedef float _Float32; ^ /usr/include/x86_64-linux-gnu/bits/floatn-common.h(251): error: invalid combination of type specifiers typedef double _Float64; äº‹å®ä¸Šåªè¦æ¸…ç†å¹²å‡€ä½¿ç”¨çš„gccå’Œg++ç‰ˆæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 ls /usr/bin/gcc* ls /usr/bin/g++* sudo apt remove gcc-10 gcc-13 g++-10 g++-13 # é€šå¸¸ubuntu20.04ä½¿ç”¨9.4ç‰ˆæœ¬çš„gccå’Œg++ # æ‰‹åŠ¨åˆ›å»ºè¿™äº›é“¾æ¥ sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 60 sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 60 # è®¾ç½®å¯¹åº”ç‰ˆæœ¬ sudo update-alternatives --config gcc sudo update-alternatives --config g++ ","permalink":"http://119.91.218.8/zh/posts/1609/","summary":"\u003cp\u003eä»Šå¤©åœ¨å°è¯•å¤ç°quip#çš„æ—¶å€™å‘ç°äº†é—®é¢˜ï¼Œåœ¨è¿›è¡Œsetup installçš„æ—¶å€™å‘ç°\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e[\u003c/span\u003e1/3\u003cspan class=\"o\"\u003e]\u003c/span\u003e /usr/local/cuda/bin/nvcc --generate-dependencies-with-compile --dependency-output /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o.d -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/torch/csrc/api/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/TH -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/THC -I/usr/local/cuda/include -I/home/ubuntu/miniconda3/envs/quant/include/python3.11 -c -c /home/ubuntu/data/exp/quip-sharp/quiptools/quiptools.cu -o /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o -D__CUDA_NO_HALF_OPERATORS__ -D__CUDA_NO_HALF_CONVERSIONS__ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr --compiler-options \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;-fPIC\u0026#39;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e -O2 -g -Xcompiler -rdynamic -lineinfo -std\u003cspan class=\"o\"\u003e=\u003c/span\u003ec++20 -DTORCH_API_INCLUDE_EXTENSION_H \u003cspan class=\"s1\"\u003e\u0026#39;-DPYBIND11_COMPILER_TYPE=\u0026#34;_gcc\u0026#34;\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-DPYBIND11_STDLIB=\u0026#34;_libstdcpp\u0026#34;\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-DPYBIND11_BUILD_ABI=\u0026#34;_cxxabi1011\u0026#34;\u0026#39;\u003c/span\u003e -DTORCH_EXTENSION_NAME\u003cspan class=\"o\"\u003e=\u003c/span\u003equiptools_cuda -D_GLIBCXX_USE_CXX11_ABI\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e -gencode\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003earch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ecompute_89,code\u003cspan class=\"o\"\u003e=\u003c/span\u003ecompute_89 -gencode\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003earch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ecompute_89,code\u003cspan class=\"o\"\u003e=\u003c/span\u003esm_89\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eFAILED: /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/local/cuda/bin/nvcc --generate-dependencies-with-compile --dependency-output /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o.d -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/torch/csrc/api/include -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/TH -I/home/ubuntu/miniconda3/envs/quant/lib/python3.11/site-packages/torch/include/THC -I/usr/local/cuda/include -I/home/ubuntu/miniconda3/envs/quant/include/python3.11 -c -c /home/ubuntu/data/exp/quip-sharp/quiptools/quiptools.cu -o /home/ubuntu/data/exp/quip-sharp/quiptools/build/temp.linux-x86_64-cpython-311/quiptools.o -D__CUDA_NO_HALF_OPERATORS__ -D__CUDA_NO_HALF_CONVERSIONS__ -D__CUDA_NO_BFLOAT16_CONVERSIONS__ -D__CUDA_NO_HALF2_OPERATORS__ --expt-relaxed-constexpr --compiler-options \u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;-fPIC\u0026#39;\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e -O2 -g -Xcompiler -rdynamic -lineinfo -std\u003cspan class=\"o\"\u003e=\u003c/span\u003ec++20 -DTORCH_API_INCLUDE_EXTENSION_H \u003cspan class=\"s1\"\u003e\u0026#39;-DPYBIND11_COMPILER_TYPE=\u0026#34;_gcc\u0026#34;\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-DPYBIND11_STDLIB=\u0026#34;_libstdcpp\u0026#34;\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;-DPYBIND11_BUILD_ABI=\u0026#34;_cxxabi1011\u0026#34;\u0026#39;\u003c/span\u003e -DTORCH_EXTENSION_NAME\u003cspan class=\"o\"\u003e=\u003c/span\u003equiptools_cuda -D_GLIBCXX_USE_CXX11_ABI\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e -gencode\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003earch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ecompute_89,code\u003cspan class=\"o\"\u003e=\u003c/span\u003ecompute_89 -gencode\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003earch\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ecompute_89,code\u003cspan class=\"o\"\u003e=\u003c/span\u003esm_89\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/include/x86_64-linux-gnu/bits/floatn-common.h\u003cspan class=\"o\"\u003e(\u003c/span\u003e214\u003cspan class=\"o\"\u003e)\u003c/span\u003e: error: invalid combination of \u003cspan class=\"nb\"\u003etype\u003c/span\u003e specifiers\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eÂ  typedef float _Float32\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eÂ  Â  Â  Â  Â  Â  Â  Â  ^\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e/usr/include/x86_64-linux-gnu/bits/floatn-common.h\u003cspan class=\"o\"\u003e(\u003c/span\u003e251\u003cspan class=\"o\"\u003e)\u003c/span\u003e: error: invalid combination of \u003cspan class=\"nb\"\u003etype\u003c/span\u003e specifiers\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eÂ  typedef double _Float64\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eäº‹å®ä¸Šåªè¦æ¸…ç†å¹²å‡€ä½¿ç”¨çš„gccå’Œg++ç‰ˆæœ¬\u003c/p\u003e","title":"è®°å½•ä¸€æ¬¡ç¼–è¯‘pytorch çš„cudaæ’ä»¶çš„è¸©å‘è¿‡ç¨‹"},{"content":"ä¸¢å¼ƒæ›´æ”¹ 1. ä¸¢å¼ƒå·¥ä½œåŒºçš„æœªæš‚å­˜æ›´æ”¹ å¦‚æœä½ åœ¨å·¥ä½œåŒºä¿®æ”¹äº†æ–‡ä»¶ä½†å°šæœªæš‚å­˜ï¼ˆä½¿ç”¨ git addï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æ–‡ä»¶æ¢å¤åˆ°ä¸Šä¸€æ¬¡æäº¤æ—¶çš„çŠ¶æ€ï¼š\n1 git checkout -- \u0026lt;file\u0026gt; è¿™ä¸ªå‘½ä»¤ä¼šä¸¢å¼ƒæŒ‡å®šæ–‡ä»¶çš„æ›´æ”¹ï¼Œæ¢å¤åˆ°ä¸Šæ¬¡æäº¤çš„ç‰ˆæœ¬ã€‚\nå¦‚æœæƒ³ä¸¢å¼ƒæ‰€æœ‰æ–‡ä»¶çš„æ›´æ”¹ï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n1 git checkout -- . 2. ä¸¢å¼ƒå·²æš‚å­˜çš„æ›´æ”¹ å¦‚æœä½ å·²ç»ä½¿ç”¨ git add å°†æ›´æ”¹æš‚å­˜ï¼Œä½†è¿˜æ²¡æœ‰æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æ›´æ”¹ä»æš‚å­˜åŒºç§»é™¤ï¼Œä½†ä¿ç•™åœ¨å·¥ä½œåŒºä¸­ï¼š\n1 git reset HEAD \u0026lt;file\u0026gt; è¿™æ ·åšä¼šå°†æ–‡ä»¶ä»æš‚å­˜åŒºç§»é™¤ï¼Œä½†å·¥ä½œåŒºä¸­çš„æ›´æ”¹ä»ç„¶å­˜åœ¨ã€‚\nå¦‚æœæƒ³å°†æ‰€æœ‰å·²æš‚å­˜çš„æ–‡ä»¶ç§»é™¤æš‚å­˜åŒºï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n1 git reset HEAD . 3. ä¸¢å¼ƒæ‰€æœ‰æœªæäº¤çš„æ›´æ”¹ï¼ˆåŒ…æ‹¬å·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼‰ å¦‚æœä½ æƒ³è¦å½»åº•ä¸¢å¼ƒæ‰€æœ‰æœªæäº¤çš„æ›´æ”¹ï¼ˆåŒ…æ‹¬å·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æ›´æ”¹ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n1 git reset --hard è¿™ä¸ªå‘½ä»¤ä¼šå°†ä½ çš„å·¥ä½œåŒºå’Œæš‚å­˜åŒºé‡ç½®åˆ°ä¸Šä¸€æ¬¡æäº¤çš„çŠ¶æ€ï¼Œæ‰€æœ‰æœªæäº¤çš„æ›´æ”¹éƒ½ä¼šä¸¢å¤±ã€‚\n4. ä¸¢å¼ƒå·²ç»æäº¤çš„æ›´æ”¹ å¦‚æœä½ å·²ç»æäº¤äº†æ›´æ”¹ï¼Œä½†æƒ³è¦æ’¤é”€æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\nå›æ»šåˆ°ä¹‹å‰çš„æäº¤ä½†ä¿ç•™æ›´æ”¹åœ¨å·¥ä½œåŒºï¼š\n1 git reset --soft \u0026lt;commit-hash\u0026gt; è¿™å°†æŠŠå½“å‰åˆ†æ”¯é‡ç½®åˆ°æŒ‡å®šçš„æäº¤ï¼Œä½†ä¿ç•™æ›´æ”¹åœ¨æš‚å­˜åŒºã€‚\nå½»åº•ä¸¢å¼ƒæäº¤åçš„æ›´æ”¹ï¼š\n1 git reset --hard \u0026lt;commit-hash\u0026gt; è¿™ä¸ªå‘½ä»¤ä¼šå°†å½“å‰åˆ†æ”¯é‡ç½®åˆ°æŒ‡å®šçš„æäº¤ï¼Œå·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æ›´æ”¹éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚\n5. ä¸¢å¼ƒç‰¹å®šæäº¤çš„æ›´æ”¹ å¦‚æœä½ æƒ³æ’¤é”€æŸä¸ªç‰¹å®šçš„æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ git revertï¼š\n1 git revert \u0026lt;commit-hash\u0026gt; è¿™ä¸ªå‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æäº¤æ¥æ’¤é”€æŒ‡å®šçš„æ›´æ”¹ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–å†å²æäº¤ã€‚\nä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶éœ€è¦è°¨æ…ï¼Œç‰¹åˆ«æ˜¯ git reset --hardï¼Œå› ä¸ºè¿™ä¼šä¸¢å¤±æ‰€æœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œæ— æ³•æ¢å¤ã€‚\n","permalink":"http://119.91.218.8/zh/posts/1429/","summary":"\u003ch3 id=\"ä¸¢å¼ƒæ›´æ”¹\"\u003eä¸¢å¼ƒæ›´æ”¹\u003c/h3\u003e\n\u003ch4 id=\"1-ä¸¢å¼ƒå·¥ä½œåŒºçš„æœªæš‚å­˜æ›´æ”¹\"\u003e1. \u003cstrong\u003eä¸¢å¼ƒå·¥ä½œåŒºçš„æœªæš‚å­˜æ›´æ”¹\u003c/strong\u003e\u003c/h4\u003e\n\u003cp\u003eå¦‚æœä½ åœ¨å·¥ä½œåŒºä¿®æ”¹äº†æ–‡ä»¶ä½†å°šæœªæš‚å­˜ï¼ˆä½¿ç”¨ \u003ccode\u003egit add\u003c/code\u003eï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æ–‡ä»¶æ¢å¤åˆ°ä¸Šä¸€æ¬¡æäº¤æ—¶çš„çŠ¶æ€ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003egit checkout -- \u0026lt;file\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eè¿™ä¸ªå‘½ä»¤ä¼šä¸¢å¼ƒæŒ‡å®šæ–‡ä»¶çš„æ›´æ”¹ï¼Œæ¢å¤åˆ°ä¸Šæ¬¡æäº¤çš„ç‰ˆæœ¬ã€‚\u003c/p\u003e","title":"å¸¸ç”¨gitæ“ä½œ"},{"content":"2 èƒŒæ™¯ æˆ‘ä»¬æä¾›äº†ä¸€äº›å…³äºç°ä»£ç¡¬ä»¶ï¼ˆGPUï¼‰ä¸Šå¸¸è§æ·±åº¦å­¦ä¹ æ“ä½œæ€§èƒ½ç‰¹æ€§çš„èƒŒæ™¯ä¿¡æ¯ï¼Œå¹¶æè¿°äº†æ³¨æ„åŠ›æœºåˆ¶çš„æ ‡å‡†å®ç°ã€‚\n2.1 ç¡¬ä»¶æ€§èƒ½ æˆ‘ä»¬ä¸»è¦å…³æ³¨GPUã€‚å…¶ä»–ç¡¬ä»¶åŠ é€Ÿå™¨çš„æ€§èƒ½ç±»ä¼¼ã€‚\nGPUå†…å­˜å±‚æ¬¡ç»“æ„\nGPUçš„å†…å­˜å±‚æ¬¡ç»“æ„ï¼ˆå›¾1å·¦ä¾§ï¼‰åŒ…å«å¤šç§ä¸åŒå¤§å°å’Œé€Ÿåº¦çš„å†…å­˜ï¼Œå…¶ä¸­è¾ƒå°çš„å†…å­˜é€Ÿåº¦æ›´å¿«ã€‚ä¾‹å¦‚ï¼ŒA100 GPUå…·æœ‰40-80GBçš„é«˜å¸¦å®½å†…å­˜ï¼ˆHBMï¼‰ï¼Œå…¶å¸¦å®½ä¸º1.5-2.0TB/sï¼Œå¹¶ä¸”æ¯ä¸ª108ä¸ªæµå¤„ç†å™¨ï¼ˆstreaming multiprocessorsï¼‰ä¸­çš„æ¯ä¸ªéƒ½å…·æœ‰192KBçš„ç‰‡ä¸ŠSRAMï¼Œå¸¦å®½ä¼°è®¡ä¸º19TB/så·¦å³ã€‚ç‰‡ä¸ŠSRAMçš„é€Ÿåº¦æ¯”HBMå¿«ä¸€ä¸ªæ•°é‡çº§ï¼Œä½†å…¶å¤§å°åˆ™å°äº†è®¸å¤šæ•°é‡çº§ã€‚éšç€è®¡ç®—é€Ÿåº¦ç›¸å¯¹äºå†…å­˜é€Ÿåº¦çš„æå‡ï¼Œæ“ä½œè¶Šæ¥è¶Šå—åˆ°å†…å­˜ï¼ˆHBMï¼‰è®¿é—®çš„ç“¶é¢ˆå½±å“ã€‚å› æ­¤ï¼Œåˆ©ç”¨å¿«é€Ÿçš„SRAMå˜å¾—æ›´åŠ é‡è¦ã€‚\næ‰§è¡Œæ¨¡å‹\nGPUæ‹¥æœ‰å¤§é‡çº¿ç¨‹æ¥æ‰§è¡Œä¸€ä¸ªæ“ä½œï¼ˆç§°ä¸ºkernelï¼‰ã€‚æ¯ä¸ªkernelä»HBMåŠ è½½è¾“å…¥åˆ°å¯„å­˜å™¨å’ŒSRAMä¸­ï¼Œè¿›è¡Œè®¡ç®—ï¼Œç„¶åå°†è¾“å‡ºå†™å…¥HBMã€‚\næ€§èƒ½ç‰¹æ€§\næ ¹æ®è®¡ç®—å’Œå†…å­˜è®¿é—®çš„å¹³è¡¡ï¼Œæ“ä½œå¯ä»¥åˆ†ä¸ºè®¡ç®—å—é™æˆ–å†…å­˜å—é™ã€‚è¿™é€šå¸¸é€šè¿‡ç®—æœ¯å¼ºåº¦æ¥è¡¡é‡ï¼Œç®—æœ¯å¼ºåº¦æ˜¯æ¯å­—èŠ‚å†…å­˜è®¿é—®çš„ç®—æœ¯æ“ä½œæ•°é‡ã€‚\nè®¡ç®—å—é™ï¼šæ“ä½œçš„æ—¶é—´å–å†³äºç®—æœ¯æ“ä½œçš„æ•°é‡ï¼Œè€Œè®¿é—®HBMçš„æ—¶é—´åˆ™è¦å°‘å¾—å¤šã€‚å…¸å‹çš„ä¾‹å­åŒ…æ‹¬å…·æœ‰å¤§å†…ç»´åº¦çš„çŸ©é˜µä¹˜æ³•å’Œå…·æœ‰å¤§é‡é€šé“çš„å·ç§¯ã€‚\nå†…å­˜å—é™ï¼šæ“ä½œçš„æ—¶é—´å–å†³äºå†…å­˜è®¿é—®çš„æ•°é‡ï¼Œè€Œè®¡ç®—æ‰€èŠ±è´¹çš„æ—¶é—´åˆ™è¦å°‘å¾—å¤šã€‚ä¾‹å­åŒ…æ‹¬å¤§å¤šæ•°å…¶ä»–æ“ä½œï¼šå…ƒç´ çº§æ“ä½œï¼ˆä¾‹å¦‚ï¼Œæ¿€æ´»ã€dropoutï¼‰ï¼Œä»¥åŠå½’çº¦æ“ä½œï¼ˆä¾‹å¦‚ï¼Œæ±‚å’Œã€softmaxã€æ‰¹é‡å½’ä¸€åŒ–ã€å±‚å½’ä¸€åŒ–ï¼‰ã€‚\nå†…æ ¸èåˆ\nåŠ é€Ÿå†…å­˜å—é™æ“ä½œçš„æœ€å¸¸è§æ–¹æ³•æ˜¯å†…æ ¸èåˆï¼šå¦‚æœæœ‰å¤šä¸ªæ“ä½œåº”ç”¨äºç›¸åŒçš„è¾“å…¥ï¼Œåˆ™è¾“å…¥å¯ä»¥ä»HBMä¸­åŠ è½½ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªæ“ä½œå¤šæ¬¡åŠ è½½ã€‚ç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨èåˆè®¸å¤šå…ƒç´ çº§æ“ä½œã€‚ç„¶è€Œï¼Œåœ¨æ¨¡å‹è®­ç»ƒçš„èƒŒæ™¯ä¸‹ï¼Œä¸­é—´å€¼ä»éœ€è¦å†™å…¥HBMä»¥ä¾›åå‘ä¼ æ’­ä½¿ç”¨ï¼Œä»è€Œé™ä½äº†ç®€å•å†…æ ¸èåˆçš„æ•ˆæœã€‚\n2.2 æ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶å®ç° ç»™å®šè¾“å…¥åºåˆ— $Q, K, V âˆˆ R^{N\\times d}$ï¼Œå…¶ä¸­ ğ‘ æ˜¯åºåˆ—é•¿åº¦ï¼Œğ‘‘ æ˜¯å¤´éƒ¨ç»´åº¦ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æ³¨æ„åŠ›è¾“å‡º$O âˆˆ R^{N\\times d}$: $$ S =QK^T\\in R^{N\\times N},\\quad P=softmax(S)\\in R^{N\\times N},\\quad O=PV\\in R^{N\\times N} $$ å…¶ä¸­ softmax æ˜¯æŒ‰è¡Œåº”ç”¨ã€applied row-wiseã€‘çš„ã€‚\næ ‡å‡†çš„æ³¨æ„åŠ›æœºåˆ¶å®ç°å°†çŸ©é˜µ S å’Œ P ç‰©åŒ–ã€materializeã€‘åˆ°é«˜å¸¦å®½å†…å­˜ï¼ˆHBMï¼‰ï¼Œè¿™éœ€è¦ ğ‘‚(ğ‘Â²) çš„å†…å­˜ã€‚é€šå¸¸ ğ‘ è¿œå¤§äº ğ‘‘ï¼ˆä¾‹å¦‚ï¼Œå¯¹äº GPT-2ï¼Œğ‘ = 1024 è€Œ ğ‘‘ = 64ï¼‰ã€‚æˆ‘ä»¬åœ¨ç®—æ³•0ä¸­æè¿°äº†æ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶çš„å®ç°ã€‚ç”±äºéƒ¨åˆ†æˆ–å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯å†…å­˜å—é™çš„ï¼ˆä¾‹å¦‚ softmaxï¼‰ï¼Œå¤§é‡çš„å†…å­˜è®¿é—®ä¼šå¯¼è‡´è¾ƒæ…¢çš„å®é™…è¿è¡Œæ—¶é—´ã€‚\nè¿™ä¸ªé—®é¢˜å› åº”ç”¨äºæ³¨æ„åŠ›çŸ©é˜µçš„å…¶ä»–å…ƒç´ çº§æ“ä½œè€ŒåŠ å‰§ï¼Œä¾‹å¦‚åº”ç”¨äº S çš„æ©ç æ“ä½œæˆ–åº”ç”¨äº P çš„ dropoutã€‚å› æ­¤ï¼Œå·²æœ‰è®¸å¤šå°è¯•å°†å‡ ä¸ªå…ƒç´ çº§æ“ä½œèåˆåœ¨ä¸€èµ·ï¼Œä¾‹å¦‚å°†æ©ç ä¸ softmax èåˆã€‚\nåœ¨ç¬¬3.2èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºæ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶å®ç°ä¸­é«˜å¸¦å®½å†…å­˜çš„è®¿é—®æ¬¡æ•°æ˜¯åºåˆ—é•¿åº¦ ğ‘ çš„å¹³æ–¹ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å°†æ¯”è¾ƒæ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶ä¸æˆ‘ä»¬çš„æ–¹æ³•ï¼ˆFlashAttentionï¼‰çš„FLOPsæ•°é‡å’Œé«˜å¸¦å®½å†…å­˜è®¿é—®æ¬¡æ•°ã€‚\nç®—æ³•0ï¼šæ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶å®ç°\nå‰ææ¡ä»¶ï¼šHBMä¸­çš„çŸ©é˜µ $Q, K, V âˆˆ R^{N\\times d}$ã€‚\nä»HBMæŒ‰å—åŠ è½½ Q å’Œ Kï¼Œè®¡ç®— $S = QKáµ€$ï¼Œå¹¶å°† S å†™å…¥ HBMã€‚ ä»HBMè¯»å– Sï¼Œè®¡ç®—$P = softmax(S)$ï¼Œå¹¶å°† P å†™å…¥ HBMã€‚ ä»HBMæŒ‰å—åŠ è½½ P å’Œ Vï¼Œè®¡ç®— $O = PV$ï¼Œå¹¶å°† O å†™å…¥ HBMã€‚ è¿”å› Oã€‚ 3 FlashAttention: ç®—æ³•ã€åˆ†æä¸æ‰©å±• æˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•åœ¨å‡å°‘HBMè¯»å–/å†™å…¥æ¬¡æ•°çš„æƒ…å†µä¸‹è®¡ç®—ç²¾ç¡®çš„æ³¨æ„åŠ›ï¼Œå¹¶ä¸”æ— éœ€ä¸ºåå‘ä¼ æ’­å­˜å‚¨å¤§å‹ä¸­é—´çŸ©é˜µã€‚è¿™äº§ç”Ÿäº†ä¸€ç§æ—¢èŠ‚çœå†…å­˜åˆåœ¨å®é™…è¿è¡Œæ—¶é—´ä¸Šæ›´å¿«çš„æ³¨æ„åŠ›ç®—æ³•ã€‚æˆ‘ä»¬åˆ†æäº†å…¶IOå¤æ‚æ€§ï¼Œè¡¨æ˜æˆ‘ä»¬çš„æ–¹æ³•ç›¸æ¯”äºæ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶éœ€è¦æ›´å°‘çš„HBMè®¿é—®æ¬¡æ•°ã€‚æˆ‘ä»¬è¿›ä¸€æ­¥å±•ç¤ºäº†FlashAttentionä½œä¸ºä¸€ä¸ªæœ‰ç”¨çš„åŸºæœ¬æ¨¡å—å¯ä»¥æ‰©å±•ä¸ºå¤„ç†å—ç¨€ç–æ³¨æ„åŠ›ã€‚\nä¸ºäº†ä¾¿äºè®²è§£ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å‰å‘ä¼ æ’­éƒ¨åˆ†ï¼›é™„å½•BåŒ…å«äº†åå‘ä¼ æ’­çš„è¯¦ç»†ä¿¡æ¯ã€‚\n3.1 ä¸€ç§ä½¿ç”¨åˆ†å—å’Œé‡è®¡ç®—çš„é«˜æ•ˆæ³¨æ„åŠ›ç®—æ³• ç»™å®šHBMä¸­çš„è¾“å…¥ $Q, K, V \\in \\mathbb{R}^{N \\times d}$ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®¡ç®—æ³¨æ„åŠ›è¾“å‡º $O \\in \\mathbb{R}^{N \\times d}$ å¹¶å°†å…¶å†™å…¥HBMã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å‡å°‘HBMè®¿é—®æ¬¡æ•°ï¼ˆåˆ° $N$ çš„äºšäºŒæ¬¡æ–¹ï¼‰ã€‚\næˆ‘ä»¬åº”ç”¨äº†ä¸¤ç§å·²ç¡®ç«‹çš„æŠ€æœ¯ï¼ˆåˆ†å—ã€é‡è®¡ç®—ï¼‰æ¥å…‹æœåœ¨ $N$ çš„äºšäºŒæ¬¡æ–¹HBMè®¿é—®æ¬¡æ•°ä¸‹è®¡ç®—ç²¾ç¡®æ³¨æ„åŠ›çš„æŠ€æœ¯æŒ‘æˆ˜ã€‚æˆ‘ä»¬åœ¨ç®—æ³•1ä¸­æè¿°äº†è¿™ä¸€è¿‡ç¨‹ã€‚ä¸»è¦æ€è·¯æ˜¯å°†è¾“å…¥ $Q, K, V$ åˆ†å—ï¼Œä»æ…¢é€ŸHBMåŠ è½½åˆ°å¿«é€ŸSRAMï¼Œç„¶åæ ¹æ®è¿™äº›å—è®¡ç®—æ³¨æ„åŠ›è¾“å‡ºã€‚é€šè¿‡åœ¨ç´¯åŠ ä¹‹å‰æŒ‰æ­£ç¡®çš„å½’ä¸€åŒ–å› å­ç¼©æ”¾æ¯ä¸ªå—çš„è¾“å‡ºï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°æ­£ç¡®çš„ç»“æœã€‚\nåˆ†å—\næˆ‘ä»¬æŒ‰å—è®¡ç®—æ³¨æ„åŠ›ã€‚Softmaxå°† $K$ çš„åˆ—è€¦åˆåœ¨ä¸€èµ·ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡ç¼©æ”¾æ¥åˆ†è§£å¤§çš„softmaxã€‚ä¸ºäº†æ•°å€¼ç¨³å®šæ€§ï¼Œå‘é‡ $x \\in \\mathbb{R}^B$ çš„softmaxè®¡ç®—å¦‚ä¸‹ï¼š $$ m(x) := \\max_i x_i, \\quad f(x) := \\left[ \\exp(x_1 - m(x)), \\dots, \\exp(x_B - m(x)) \\right], \\quad \\ell(x) := \\sum_i f(x)_i, \\quad \\text{softmax}(x) := \\frac{f(x)}{\\ell(x)} $$ å¯¹äºå‘é‡ $x^{(1)}, x^{(2)} \\in \\mathbb{R}^B$ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†è§£è¿æ¥åçš„ $x = \\left[ x^{(1)}, x^{(2)} \\right] \\in \\mathbb{R}^{2B}$ çš„softmaxè®¡ç®—ä¸ºï¼š $$ m(x) = m\\left(\\left[ x^{(1)}, x^{(2)} \\right]\\right) = \\max\\left(m(x^{(1)}), m(x^{(2)})\\right), \\quad f(x) = \\left[ \\exp(m(x^{(1)}) - m(x)) f(x^{(1)}), \\exp(m(x^{(2)}) - m(x)) f(x^{(2)}) \\right], $$ $$ \\ell(x) = \\ell\\left(\\left[ x^{(1)}, x^{(2)} \\right]\\right) = \\exp(m(x^{(1)}) - m(x)) \\ell(x^{(1)}) + \\exp(m(x^{(2)}) - m(x)) \\ell(x^{(2)}), \\quad \\text{softmax}(x) = \\frac{f(x)}{\\ell(x)} $$ å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è·Ÿè¸ªä¸€äº›é¢å¤–çš„ç»Ÿè®¡æ•°æ®ï¼ˆ$m(x), \\ell(x)$ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡è®¡ç®—ä¸€ä¸ªå—çš„softmaxå€¼ã€‚æˆ‘ä»¬å°†è¾“å…¥ $Q, K, V$ åˆ†å—ï¼ˆç®—æ³•1ç¬¬3è¡Œï¼‰ï¼Œè®¡ç®—softmaxå€¼åŠé¢å¤–çš„ç»Ÿè®¡æ•°æ®ï¼ˆç®—æ³•1ç¬¬10è¡Œï¼‰ï¼Œå¹¶åˆå¹¶ç»“æœï¼ˆç®—æ³•1ç¬¬12è¡Œï¼‰ã€‚\né‡è®¡ç®—\næˆ‘ä»¬çš„ç›®æ ‡ä¹‹ä¸€æ˜¯é¿å…å­˜å‚¨ $O(N^2)$ ä¸ªç”¨äºåå‘ä¼ æ’­çš„ä¸­é—´å€¼ã€‚åå‘ä¼ æ’­é€šå¸¸éœ€è¦çŸ©é˜µ $S, P \\in \\mathbb{R}^{N \\times N}$ æ¥è®¡ç®—ç›¸å¯¹äº $Q, K, V$ çš„æ¢¯åº¦ã€‚ç„¶è€Œï¼Œé€šè¿‡å­˜å‚¨è¾“å‡º $O$ å’Œsoftmaxå½’ä¸€åŒ–ç»Ÿè®¡æ•°æ®ï¼ˆ$m, \\ell$ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ä»SRAMä¸­çš„ $Q, K, V$ å—è½»æ¾é‡è®¡ç®—æ³¨æ„åŠ›çŸ©é˜µ $S$ å’Œ $P$ã€‚è¿™å¯ä»¥è§†ä¸ºä¸€ç§é€‰æ‹©æ€§æ¢¯åº¦æ£€æŸ¥ç‚¹ç­–ç•¥ã€‚è™½ç„¶æ¢¯åº¦æ£€æŸ¥ç‚¹ç­–ç•¥å·²è¢«å»ºè®®ç”¨äºå‡å°‘æ‰€éœ€çš„æœ€å¤§å†…å­˜é‡ï¼Œä½†æ‰€æœ‰å·²çŸ¥çš„å®ç°éƒ½ä¸å¾—ä¸åœ¨é€Ÿåº¦å’Œå†…å­˜ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå³ä½¿æœ‰æ›´å¤šçš„FLOPsï¼Œæˆ‘ä»¬çš„é‡è®¡ç®—ç”±äºå‡å°‘äº†HBMè®¿é—®æ¬¡æ•°è€ŒåŠ å¿«äº†åå‘ä¼ æ’­è¿‡ç¨‹ã€‚å®Œæ•´çš„åå‘ä¼ æ’­æè¿°è§é™„å½•Bã€‚\nå®ç°ç»†èŠ‚ï¼šå†…æ ¸èåˆ\nåˆ†å—ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸€ä¸ªCUDAå†…æ ¸ä¸­å®ç°æˆ‘ä»¬çš„ç®—æ³•ï¼Œä»HBMåŠ è½½è¾“å…¥ï¼Œæ‰§è¡Œæ‰€æœ‰è®¡ç®—æ­¥éª¤ï¼ˆçŸ©é˜µä¹˜æ³•ã€softmaxã€å¯é€‰çš„æ©ç å’Œdropoutã€çŸ©é˜µä¹˜æ³•ï¼‰ï¼Œç„¶åå°†ç»“æœå†™å›HBMï¼ˆæ©ç å’Œdropoutåœ¨é™„å½•Bä¸­ï¼‰ã€‚è¿™é¿å…äº†åå¤ä»HBMè¯»å–å’Œå†™å…¥è¾“å…¥å’Œè¾“å‡ºã€‚\nç®—æ³•1ï¼šFlashAttention\nå‰ææ¡ä»¶ï¼šHBMä¸­çš„çŸ©é˜µ $Q, K, V \\in \\mathbb{R}^{N \\times d}$ï¼Œç‰‡ä¸ŠSRAMå¤§å°ä¸º $M$ã€‚\nè®¾ç½®å—å¤§å° $B_c = \\left\\lceil \\frac{M}{4d} \\right\\rceil$, $B_r = min ( \\lceil \\frac{M}{4d} \\rceil ,d)$. åˆå§‹åŒ– $O = (0)_{N \\times d} \\in \\mathbb{R}^{N \\times d}$, $\\ell = (0)_N \\in \\mathbb{R}^N$, $m = (-\\infty)_N \\in \\mathbb{R}^N$ åœ¨HBMä¸­ã€‚ å°† $Q$ åˆ†æˆ $T_r = \\left\\lceil \\frac{N}{B_r} \\right\\rceil$ ä¸ªå— $Q_1, \\dots, Q_{T_r}$ ï¼Œæ¯ä¸ªå¤§å°ä¸º $B_r \\times d$ï¼›å°† $K, V$ åˆ†æˆ $T_c = \\left\\lceil \\frac{N}{B_c} \\right\\rceil$ ä¸ªå— $K_1, \\dots, K_{T_c}$ å’Œ $V_1, \\dots, V_{T_c}$ ï¼Œæ¯ä¸ªå¤§å°ä¸º $B_c \\times d$ã€‚ å°† $O$ åˆ†æˆ $T_r$ ä¸ªå— $O_i, \\dots, O_{T_r}$ ï¼Œæ¯ä¸ªå¤§å°ä¸º $B_r \\times d$ï¼›å°† $\\ell$ åˆ†æˆ $T_r$ ä¸ªå— $\\ell_i, \\dots, \\ell_{T_r}$ ï¼Œæ¯ä¸ªå¤§å°ä¸º $B_r$ï¼›å°† $m$ åˆ†æˆ $T_r$ ä¸ªå— $m_1, \\dots, m_{T_r}$ ï¼Œæ¯ä¸ªå¤§å°ä¸º $B_r$ã€‚ å¯¹äº $1 \\leq j \\leq T_c$ï¼š ä»HBMåŠ è½½ $K_j, V_j$ åˆ°ç‰‡ä¸ŠSRAMã€‚ å¯¹äº $1 \\leq i \\leq T_r$ï¼š ä»HBMåŠ è½½ $Q_i, O_i, \\ell_i, m_i$ åˆ°ç‰‡ä¸ŠSRAMã€‚ åœ¨ç‰‡ä¸Šè®¡ç®— $S_{ij} = Q_i K_j^\\top \\in \\mathbb{R}^{B_r \\times B_c}$ã€‚ åœ¨ç‰‡ä¸Šè®¡ç®— $\\tilde{m}{ij} = \\text{rowmax}(S{ij}) \\in \\mathbb{R}^{B_r}$ï¼Œ$\\tilde{P}{ij} = \\exp(S{ij} - \\tilde{m}{ij}) \\in \\mathbb{R}^{B_r \\times B_c}$ï¼ˆé€ç‚¹è®¡ç®—ï¼‰ï¼Œ$\\tilde{\\ell}{ij} = \\text{rowsum}(\\tilde{P}_{ij}) \\in \\mathbb{R}^{B_r}$ã€‚ åœ¨ç‰‡ä¸Šè®¡ç®— $m_{i}^{\\text{new}} = \\max(m_i, \\tilde{m}{ij}) \\in \\mathbb{R}^{B_r}$ï¼Œ$\\ell{i}^{\\text{new}} = \\exp(m_i - m_{i}^{\\text{new}})\\ell_i + \\exp(\\tilde{m}{ij} - m{i}^{\\text{new}})\\tilde{\\ell}_{ij} \\in \\mathbb{R}^{B_r}$ã€‚ å†™å…¥$$O_i \\leftarrow \\text{diag}(\\ell_{i}^{\\text{new}})^{-1}\\left(\\text{diag}(\\ell_i)\\exp(m_i-m {i}^{\\text{new}})O_i + \\exp(\\tilde{m}{ij} - m_{i}^{\\text{new}})\\tilde{P}_{ij}V_j\\right)$$ åˆ°HBMã€‚ å†™å…¥ $\\ell_i \\leftarrow \\ell_{i}^{\\text{new}}$ï¼Œ$m_i \\leftarrow m_{i}^{\\text{new}}$ åˆ°HBMã€‚ ç»“æŸå¾ªç¯ ç»“æŸå¾ªç¯ è¿”å› $O$ã€‚ æˆ‘ä»¬è¯æ˜äº†FlashAttentionçš„æ­£ç¡®æ€§ã€è¿è¡Œæ—¶é—´å’Œå†…å­˜éœ€æ±‚ï¼ˆè¯æ˜åœ¨é™„å½•Cä¸­ï¼‰ã€‚\nå®šç†1ï¼šç®—æ³•1è¿”å› $O = \\text{softmax}(QK^\\top)V$ ï¼Œå…·æœ‰ $\\mathcal{O}(N^2d)$ çš„FLOPsï¼Œå¹¶ä¸”é™¤äº†è¾“å…¥å’Œè¾“å‡ºä¹‹å¤–ä»…éœ€è¦ $\\mathcal{O}(N)$ çš„é¢å¤–å†…å­˜ã€‚\n","permalink":"http://119.91.218.8/zh/posts/1647/","summary":"\u003ch2 id=\"2-èƒŒæ™¯\"\u003e2 èƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæˆ‘ä»¬æä¾›äº†ä¸€äº›å…³äºç°ä»£ç¡¬ä»¶ï¼ˆGPUï¼‰ä¸Šå¸¸è§æ·±åº¦å­¦ä¹ æ“ä½œæ€§èƒ½ç‰¹æ€§çš„èƒŒæ™¯ä¿¡æ¯ï¼Œå¹¶æè¿°äº†æ³¨æ„åŠ›æœºåˆ¶çš„æ ‡å‡†å®ç°ã€‚\u003c/p\u003e\n\u003ch3 id=\"21-ç¡¬ä»¶æ€§èƒ½\"\u003e2.1 ç¡¬ä»¶æ€§èƒ½\u003c/h3\u003e\n\u003cp\u003eæˆ‘ä»¬ä¸»è¦å…³æ³¨GPUã€‚å…¶ä»–ç¡¬ä»¶åŠ é€Ÿå™¨çš„æ€§èƒ½ç±»ä¼¼ã€‚\u003c/p\u003e","title":"FlashAttention Fast and Memory-Efficient Exact Attention with IO-Awareness"}]